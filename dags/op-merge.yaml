# op-merge.yaml
# Merges approved work and cleans up

name: op-merge
params:
  - REPO: ""
  - ISSUE_JSON: ""

steps:
  - name: extract-info
    command: |
      echo '${ISSUE_JSON}' | jq -r '.id'
    output: ISSUE_ID

  - name: extract-title
    command: |
      echo '${ISSUE_JSON}' | jq -r '.title'
    output: ISSUE_TITLE

  - name: get-worktree
    command: |
      echo "${REPO}/.worktrees/${ISSUE_ID}"
    output: WORKTREE_PATH

  - name: get-branch
    command: |
      echo "work/${ISSUE_ID}"
    output: BRANCH_NAME

  - name: cleanup-tunnel
    command: |
      # Stop cloudflared if running
      if [ -f "/tmp/cloudflared-${ISSUE_ID}.pid" ]; then
        kill $(cat /tmp/cloudflared-${ISSUE_ID}.pid) 2>/dev/null || true
        rm /tmp/cloudflared-${ISSUE_ID}.pid
      fi
      # Stop dev server if running
      if [ -f "/tmp/dev-server-${ISSUE_ID}.pid" ]; then
        kill $(cat /tmp/dev-server-${ISSUE_ID}.pid) 2>/dev/null || true
        rm /tmp/dev-server-${ISSUE_ID}.pid
      fi
    continueOn:
      failure: true

  - name: merge-to-main
    dir: ${REPO}
    command: |
      # Ensure we're on main
      git checkout main

      # Merge the work branch
      git merge --no-ff ${BRANCH_NAME} -m "Merge ${ISSUE_ID}: ${ISSUE_TITLE}

      Automated merge by beads-cron.
      Issue: ${ISSUE_ID}"

  - name: cleanup-worktree
    dir: ${REPO}
    command: |
      # Remove worktree
      git worktree remove ${WORKTREE_PATH} --force 2>/dev/null || true

      # Delete branch
      git branch -d ${BRANCH_NAME} 2>/dev/null || true

  - name: close-issue
    dir: ${REPO}
    command: |
      bd label remove ${ISSUE_ID} human-approved 2>/dev/null || true
      bd label remove ${ISSUE_ID} awaiting-human-review 2>/dev/null || true
      bd close ${ISSUE_ID} --reason "Merged to main"

  - name: log-result
    command: |
      echo "[$(date)] Merged and closed ${ISSUE_ID}"
